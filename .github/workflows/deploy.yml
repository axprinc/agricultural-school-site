name: Build and Deploy to Heroku

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint (if available)
        run: npm run lint --if-present

      - name: Build
        run: npm run build

  deploy:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Heroku CLI
        # Ensure heroku command is available for deploy step
        run: |
          curl https://cli-assets.heroku.com/install-ubuntu.sh | sh

      - name: Verify Heroku CLI
        run: heroku --version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Authenticate to Heroku
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_EMAIL: "info@a-medical-clinic.jp"
        run: |
          cat > ~/.netrc <<EOF
          machine api.heroku.com
            login ${HEROKU_EMAIL}
            password ${HEROKU_API_KEY}
          machine git.heroku.com
            login ${HEROKU_EMAIL}
            password ${HEROKU_API_KEY}
          EOF
          chmod 600 ~/.netrc

      - name: Deploy to Heroku (git push)
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        run: |
          set -e
          # 明示的にリモートをURL指定で追加（存在すれば上書き）
          git remote remove heroku >/dev/null 2>&1 || true
          git remote add heroku https://heroku:${HEROKU_API_KEY}@git.heroku.com/agricultural-school-site.git
          git remote -v
          git push heroku HEAD:main -f
